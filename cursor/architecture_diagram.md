# KiotProxy Manager - Simplified Architecture

## System Overview

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Users/Applications                    â”‚
â”‚  Configure HTTP Proxy to: proxy1.domain.com:80          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â”‚ HTTP/HTTPS
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Traefik                             â”‚
â”‚  Wildcard Domain Router (*.domain.com)                   â”‚
â”‚                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  app.domain.com      â†’ Frontend                    â”‚ â”‚
â”‚  â”‚  proxy1.domain.com   â†’ Proxy Handler 1 (port 9001)â”‚ â”‚
â”‚  â”‚  proxy2.domain.com   â†’ Proxy Handler 2 (port 9002)â”‚ â”‚
â”‚  â”‚  proxy3.domain.com   â†’ Proxy Handler 3 (port 9003)â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Backend Container                      â”‚
â”‚                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  FastAPI Application (Port 8000)                   â”‚ â”‚
â”‚  â”‚  - /api/auth/*      (Login/Logout)                 â”‚ â”‚
â”‚  â”‚  - /api/proxies/*   (CRUD operations)              â”‚ â”‚
â”‚  â”‚  - /api/logs/*      (View logs)                    â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  Proxy Handlers                                    â”‚ â”‚
â”‚  â”‚                                                    â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚
â”‚  â”‚  â”‚  Handler 1 (Port 9001)                       â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  Forwards via: 171.243.255.207:31194         â”‚ â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚
â”‚  â”‚                                                    â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚
â”‚  â”‚  â”‚  Handler 2 (Port 9002)                       â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  Forwards via: 116.97.68.237:18173           â”‚ â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚
â”‚  â”‚                                                    â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚
â”‚  â”‚  â”‚  Handler 3 (Port 9003)                       â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  Forwards via: 27.73.175.36:26271            â”‚ â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  Background Worker                                 â”‚ â”‚
â”‚  â”‚  - Health checks every 30s                         â”‚ â”‚
â”‚  â”‚  - Auto-rotation based on TTC                      â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  data/data.json                                    â”‚ â”‚
â”‚  â”‚  { users: [...], proxy_keys: [...], logs: [...] } â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â”‚ HTTPS
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              KiotProxy API                               â”‚
â”‚  api.kiotproxy.com/api/v1/proxies/*                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Request Flow Diagrams

### 1. User Adds New Proxy Key

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  User   â”‚   â”‚ Frontend â”‚   â”‚ Backend â”‚   â”‚ Traefik  â”‚   â”‚ KiotProxyâ”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
     â”‚              â”‚              â”‚             â”‚              â”‚
     â”‚ Click "Add"  â”‚              â”‚             â”‚              â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚              â”‚             â”‚              â”‚
     â”‚              â”‚              â”‚             â”‚              â”‚
     â”‚ Enter detailsâ”‚              â”‚             â”‚              â”‚
     â”‚ - Key name   â”‚              â”‚             â”‚              â”‚
     â”‚ - KP key     â”‚              â”‚             â”‚              â”‚
     â”‚ - Region     â”‚              â”‚             â”‚              â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚              â”‚             â”‚              â”‚
     â”‚              â”‚              â”‚             â”‚              â”‚
     â”‚              â”‚ POST /api/proxies          â”‚              â”‚
     â”‚              â”‚ {key_name, kiotproxy_key}  â”‚              â”‚
     â”‚              â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚             â”‚              â”‚
     â”‚              â”‚              â”‚             â”‚              â”‚
     â”‚              â”‚              â”‚ GET /proxies/new           â”‚
     â”‚              â”‚              â”‚ ?key=xxx&region=random     â”‚
     â”‚              â”‚              â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
     â”‚              â”‚              â”‚             â”‚              â”‚
     â”‚              â”‚              â”‚ Returns:   â”‚              â”‚
     â”‚              â”‚              â”‚ {          â”‚              â”‚
     â”‚              â”‚              â”‚   http: "171.243.255.207:31194",
     â”‚              â”‚              â”‚   location: "BÃ¬nh Thuáº­n"   â”‚
     â”‚              â”‚              â”‚ }          â”‚              â”‚
     â”‚              â”‚              â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
     â”‚              â”‚              â”‚             â”‚              â”‚
     â”‚              â”‚              â”‚ 1. Allocate subdomain      â”‚
     â”‚              â”‚              â”‚    (proxy1)â”‚              â”‚
     â”‚              â”‚              â”‚ 2. Start proxy handler     â”‚
     â”‚              â”‚              â”‚    on port 9001            â”‚
     â”‚              â”‚              â”‚ 3. Update Traefik config   â”‚
     â”‚              â”‚              â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚              â”‚
     â”‚              â”‚              â”‚ Add route:  â”‚              â”‚
     â”‚              â”‚              â”‚ proxy1.domain.com -> 9001  â”‚
     â”‚              â”‚              â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤              â”‚
     â”‚              â”‚              â”‚ 4. Save to data.json       â”‚
     â”‚              â”‚              â”‚                            â”‚
     â”‚              â”‚ Returns:     â”‚             â”‚              â”‚
     â”‚              â”‚ {            â”‚             â”‚              â”‚
     â”‚              â”‚   endpoint: "proxy1.domain.com"          â”‚
     â”‚              â”‚   remote_ip: "171.243.255.207"           â”‚
     â”‚              â”‚ }            â”‚             â”‚              â”‚
     â”‚              â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤             â”‚              â”‚
     â”‚              â”‚              â”‚             â”‚              â”‚
     â”‚ Display:     â”‚              â”‚             â”‚              â”‚
     â”‚ "Endpoint:   â”‚              â”‚             â”‚              â”‚
     â”‚ proxy1.domain.com"          â”‚             â”‚              â”‚
     â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤              â”‚             â”‚              â”‚
     â”‚              â”‚              â”‚             â”‚              â”‚
```

---

### 2. Using the Proxy

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Browser  â”‚   â”‚ Traefik  â”‚   â”‚Proxy Handlerâ”‚   â”‚  KiotProxy  â”‚   â”‚ Target â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
     â”‚              â”‚                 â”‚                 â”‚              â”‚
     â”‚ Configure:   â”‚                 â”‚                 â”‚              â”‚
     â”‚ HTTP Proxy = â”‚                 â”‚                 â”‚              â”‚
     â”‚ proxy1.domain.com:80           â”‚                 â”‚              â”‚
     â”‚              â”‚                 â”‚                 â”‚              â”‚
     â”‚ Visit google.com               â”‚                 â”‚              â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                 â”‚                 â”‚              â”‚
     â”‚ Host: proxy1.domain.com        â”‚                 â”‚              â”‚
     â”‚              â”‚                 â”‚                 â”‚              â”‚
     â”‚              â”‚ Route to port 9001                â”‚              â”‚
     â”‚              â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                 â”‚              â”‚
     â”‚              â”‚                 â”‚                 â”‚              â”‚
     â”‚              â”‚                 â”‚ Forward via KP  â”‚              â”‚
     â”‚              â”‚                 â”‚ 171.243.255.207:31194          â”‚
     â”‚              â”‚                 â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚              â”‚
     â”‚              â”‚                 â”‚                 â”‚              â”‚
     â”‚              â”‚                 â”‚                 â”‚ GET google.com
     â”‚              â”‚                 â”‚                 â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
     â”‚              â”‚                 â”‚                 â”‚              â”‚
     â”‚              â”‚                 â”‚                 â”‚  Response    â”‚
     â”‚              â”‚                 â”‚                 â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
     â”‚              â”‚                 â”‚                 â”‚              â”‚
     â”‚              â”‚                 â”‚   Response      â”‚              â”‚
     â”‚              â”‚                 â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤              â”‚
     â”‚              â”‚                 â”‚                 â”‚              â”‚
     â”‚              â”‚   Response      â”‚                 â”‚              â”‚
     â”‚              â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                 â”‚              â”‚
     â”‚              â”‚                 â”‚                 â”‚              â”‚
     â”‚  Response    â”‚                 â”‚                 â”‚              â”‚
     â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                 â”‚                 â”‚              â”‚
     â”‚ (shows google.com content)     â”‚                 â”‚              â”‚
     â”‚              â”‚                 â”‚                 â”‚              â”‚
```

---

### 3. Rotating Proxy

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  User   â”‚   â”‚ Frontend â”‚   â”‚ Backend â”‚   â”‚ KiotProxyâ”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
     â”‚              â”‚              â”‚             â”‚
     â”‚ Click ðŸ”„     â”‚              â”‚             â”‚
     â”‚ Rotate       â”‚              â”‚             â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚              â”‚             â”‚
     â”‚              â”‚              â”‚             â”‚
     â”‚              â”‚ POST /api/proxies/1/rotate â”‚
     â”‚              â”‚ {region: "nam"}            â”‚
     â”‚              â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚             â”‚
     â”‚              â”‚              â”‚             â”‚
     â”‚              â”‚              â”‚ GET /proxies/new
     â”‚              â”‚              â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
     â”‚              â”‚              â”‚             â”‚
     â”‚              â”‚              â”‚ Returns new proxy:
     â”‚              â”‚              â”‚ 116.97.68.237:18173
     â”‚              â”‚              â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
     â”‚              â”‚              â”‚             â”‚
     â”‚              â”‚              â”‚ Update handler:
     â”‚              â”‚              â”‚ - New remote proxy
     â”‚              â”‚              â”‚ - Same port (9001)
     â”‚              â”‚              â”‚ - Same subdomain
     â”‚              â”‚              â”‚   (proxy1)
     â”‚              â”‚              â”‚             â”‚
     â”‚              â”‚              â”‚ Save to data.json
     â”‚              â”‚              â”‚             â”‚
     â”‚              â”‚ Success:     â”‚             â”‚
     â”‚              â”‚ {            â”‚             â”‚
     â”‚              â”‚   new_ip: "116.97.68.237" â”‚
     â”‚              â”‚   location: "Thanh HÃ³a"   â”‚
     â”‚              â”‚ }            â”‚             â”‚
     â”‚              â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤             â”‚
     â”‚              â”‚              â”‚             â”‚
     â”‚ UI updates   â”‚              â”‚             â”‚
     â”‚ New IP shown â”‚              â”‚             â”‚
     â”‚ Subdomain    â”‚              â”‚             â”‚
     â”‚ unchanged    â”‚              â”‚             â”‚
     â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤              â”‚             â”‚
     â”‚              â”‚              â”‚             â”‚

Note: proxy1.domain.com still works, just routes through new IP now
```

---

## Component Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     React Frontend                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ LoginPage    â”‚  â”‚ ProxyTable   â”‚  â”‚ AddProxyDialog  â”‚  â”‚
â”‚  â”‚              â”‚  â”‚  Component   â”‚  â”‚                 â”‚  â”‚
â”‚  â”‚ - Username   â”‚  â”‚  - List all  â”‚  â”‚ - Key name     â”‚  â”‚
â”‚  â”‚ - Password   â”‚  â”‚  - Actions   â”‚  â”‚ - KP API key   â”‚  â”‚
â”‚  â”‚ - Submit     â”‚  â”‚  - Status    â”‚  â”‚ - Region       â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                            â”‚
â”‚              Axios HTTP calls to /api/*                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  FastAPI Backend                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  main.py - FastAPI App                               â”‚  â”‚
â”‚  â”‚  @app.post("/api/auth/login")                        â”‚  â”‚
â”‚  â”‚  @app.get("/api/proxies")                            â”‚  â”‚
â”‚  â”‚  @app.post("/api/proxies")                           â”‚  â”‚
â”‚  â”‚  @app.post("/api/proxies/{id}/rotate")              â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚               â”‚               â”‚                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚  â”‚  auth.py         â”‚  â”‚  kiotproxy.py     â”‚              â”‚
â”‚  â”‚  - session check â”‚  â”‚  - API client     â”‚              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â”‚                                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  proxy_handler.py                                    â”‚  â”‚
â”‚  â”‚                                                      â”‚  â”‚
â”‚  â”‚  class ProxyHandler:                                â”‚  â”‚
â”‚  â”‚    - HTTP proxy server                              â”‚  â”‚
â”‚  â”‚    - Forwards through remote KiotProxy              â”‚  â”‚
â”‚  â”‚    - Can hot-swap remote on rotation                â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  database.py                                         â”‚  â”‚
â”‚  â”‚  - load_data() â†’ reads data.json                    â”‚  â”‚
â”‚  â”‚  - save_data() â†’ writes data.json                   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  traefik_config.py                                   â”‚  â”‚
â”‚  â”‚  - update_traefik_routes()                           â”‚  â”‚
â”‚  â”‚  - Writes traefik/dynamic/proxies.yml               â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  worker.py (Background Tasks)                        â”‚  â”‚
â”‚  â”‚  - health_check_loop()                               â”‚  â”‚
â”‚  â”‚  - auto_rotation_loop()                              â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Data Structure (data.json)

```json
{
  "settings": {
    "auto_rotate_on_expiration": true,
    "auto_rotate_interval_enabled": false,
    "auto_rotate_interval_minutes": 10
  },
  
  "users": [
    {
      "id": 1,
      "username": "admin",
      "password": "$2b$12$hashed_password_here",
      "session_id": "abc123xyz789",
      "session_expires": "2025-11-14T10:00:00Z"
    }
  ],
  
  "proxy_keys": [
    {
      "id": 1,
      "user_id": 1,
      "key_name": "My Proxy 1",
      "kiotproxy_key": "K6fa3db6...4a77ce",
      "subdomain": "proxy1",
      "port": 9001,
      "region": "random",
      "is_active": true,
      
      "remote_http": "171.243.255.207:31194",
      "remote_ip": "171.243.255.207",
      "location": "BÃ¬nh Thuáº­n",
      
      "status": "active",
      "latency_ms": 539,
      "last_check_at": "2025-11-13T10:30:00Z",
      
      "expiration_at": "2025-11-13T12:00:00Z",
      "ttl": 1200,
      "ttc": 847,
      "last_rotated_at": "2025-11-13T09:00:00Z",
      
      "created_at": "2025-11-13T09:00:00Z"
    },
    {
      "id": 2,
      "user_id": 1,
      "key_name": "My Proxy 2",
      "kiotproxy_key": "K036684f...89d8b0",
      "subdomain": "proxy2",
      "port": 9002,
      "region": "bac",
      "is_active": true,
      
      "remote_http": "116.97.68.237:18173",
      "remote_ip": "116.97.68.237",
      "location": "Thanh HÃ³a",
      
      "status": "active",
      "latency_ms": 847,
      "last_check_at": "2025-11-13T10:30:00Z",
      
      "expiration_at": "2025-11-13T12:00:00Z",
      "ttl": 1200,
      "ttc": 1387,
      "last_rotated_at": "2025-11-13T09:05:00Z",
      
      "created_at": "2025-11-13T09:05:00Z"
    }
  ],
  
  "logs": [
    {
      "id": 1,
      "proxy_id": 1,
      "action": "create",
      "region": "random",
      "status": "success",
      "details": "Initial proxy fetch",
      "timestamp": "2025-11-13T09:00:00Z"
    },
    {
      "id": 2,
      "proxy_id": 1,
      "action": "rotate",
      "region": "nam",
      "status": "success",
      "details": "Rotated to 171.243.255.207",
      "timestamp": "2025-11-13T10:15:00Z"
    }
  ]
}
```

---

## Traefik Configuration Files

### Static Config (docker-compose.yml)
```yaml
traefik:
  command:
    - "--providers.docker=true"
    - "--providers.file.directory=/etc/traefik/dynamic"
    - "--providers.file.watch=true"  # Auto-reload changes
```

### Dynamic Config (traefik/dynamic/proxies.yml)
Generated by backend when proxies are added/removed:

```yaml
http:
  routers:
    # Proxy 1
    proxy1-router:
      rule: "Host(`proxy1.domain.com`)"
      service: proxy1-service
      entryPoints:
        - web
    
    # Proxy 2
    proxy2-router:
      rule: "Host(`proxy2.domain.com`)"
      service: proxy2-service
      entryPoints:
        - web
    
    # Proxy 3
    proxy3-router:
      rule: "Host(`proxy3.domain.com`)"
      service: proxy3-service
      entryPoints:
        - web

  services:
    proxy1-service:
      loadBalancer:
        servers:
          - url: "http://backend:9001"
    
    proxy2-service:
      loadBalancer:
        servers:
          - url: "http://backend:9002"
    
    proxy3-service:
      loadBalancer:
        servers:
          - url: "http://backend:9003"
```

**Note**: This file is automatically regenerated by the backend whenever:
- A new proxy is added
- A proxy is deleted
- Backend restarts (reads from data.json and rebuilds config)

---

## Subdomain Allocation Map

```
Available Subdomains: proxy1 - proxy999

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Subdomain Allocation Status                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  proxy1    [â–ˆâ–ˆâ–ˆ ALLOCATED â–ˆâ–ˆâ–ˆ]  â†’ Key ID: 1    â”‚
â”‚  proxy2    [â–ˆâ–ˆâ–ˆ ALLOCATED â–ˆâ–ˆâ–ˆ]  â†’ Key ID: 2    â”‚
â”‚  proxy3    [â–ˆâ–ˆâ–ˆ ALLOCATED â–ˆâ–ˆâ–ˆ]  â†’ Key ID: 3    â”‚
â”‚  proxy4    [     AVAILABLE    ]                â”‚
â”‚  proxy5    [     AVAILABLE    ]                â”‚
â”‚  proxy6    [     AVAILABLE    ]                â”‚
â”‚  ...                                           â”‚
â”‚  proxy999  [     AVAILABLE    ]                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Internal Port Mapping:
  proxy1.domain.com  â†’  backend:9001  â†’  KP: 171.243.255.207:31194
  proxy2.domain.com  â†’  backend:9002  â†’  KP: 116.97.68.237:18173
  proxy3.domain.com  â†’  backend:9003  â†’  KP: 27.73.175.36:26271
```

---

## Port Mapping Overview

```
External (Public)           Internal (Docker)           Remote (KiotProxy)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

proxy1.domain.com:80  â†’  backend:9001  â†’  171.243.255.207:31194
proxy2.domain.com:80  â†’  backend:9002  â†’  116.97.68.237:18173
proxy3.domain.com:80  â†’  backend:9003  â†’  27.73.175.36:26271

app.domain.com:80     â†’  frontend:80

app.domain.com/api/*  â†’  backend:8000
```

---

## Health Check Flow

```
Background Worker (runs every 30 seconds)
    â”‚
    â”œâ”€> For each proxy in data.json where is_active=true:
    â”‚   â”‚
    â”‚   â”œâ”€> Test connection:
    â”‚   â”‚   curl -x http://127.0.0.1:900X https://example.com
    â”‚   â”‚   (using internal port)
    â”‚   â”‚
    â”‚   â”œâ”€> Measure latency (milliseconds)
    â”‚   â”‚
    â”‚   â”œâ”€> Update data.json:
    â”‚   â”‚   {
    â”‚   â”‚     status: 'active' or 'error',
    â”‚   â”‚     latency_ms: measured_value,
    â”‚   â”‚     last_check_at: current_timestamp
    â”‚   â”‚   }
    â”‚   â”‚
    â”‚   â””â”€> If error after 3 consecutive failures:
    â”‚         - Mark status as 'error'
    â”‚         - Try to restart proxy handler
    â”‚         - Log the issue
    â”‚
    â””â”€> Sleep 30 seconds â†’ Repeat
```

---

## Auto-Rotation Flow

### Background Worker (runs every 30 seconds)

```
Auto-Rotation Worker
    â”‚
    â”œâ”€> Load settings from data.json
    â”‚
    â”œâ”€> OPTION 1: Auto-rotate on expiration (if enabled)
    â”‚   â”‚
    â”‚   â”œâ”€> For each active proxy:
    â”‚   â”‚   â”‚
    â”‚   â”‚   â”œâ”€> Check expiration_at timestamp
    â”‚   â”‚   â”‚   IF now >= expiration_at - 1 minute:
    â”‚   â”‚   â”‚       â”‚
    â”‚   â”‚   â”‚       â”œâ”€> Call KiotProxy API:
    â”‚   â”‚   â”‚       â”‚   GET /proxies/new?key=xxx&region=<saved_region>
    â”‚   â”‚   â”‚       â”‚
    â”‚   â”‚   â”‚       â”œâ”€> Get new proxy info:
    â”‚   â”‚   â”‚       â”‚   {
    â”‚   â”‚   â”‚       â”‚     http: "new.ip.addr:port",
    â”‚   â”‚   â”‚       â”‚     location: "New Location",
    â”‚   â”‚   â”‚       â”‚     expirationAt: "timestamp",
    â”‚   â”‚   â”‚       â”‚     ttl: 1800
    â”‚   â”‚   â”‚       â”‚   }
    â”‚   â”‚   â”‚       â”‚
    â”‚   â”‚   â”‚       â”œâ”€> Update proxy handler:
    â”‚   â”‚   â”‚       â”‚   handler.update_remote(new_proxy)
    â”‚   â”‚   â”‚       â”‚   (no restart, hot-swap)
    â”‚   â”‚   â”‚       â”‚
    â”‚   â”‚   â”‚       â”œâ”€> Update data.json:
    â”‚   â”‚   â”‚       â”‚   {
    â”‚   â”‚   â”‚       â”‚     remote_http: new value,
    â”‚   â”‚   â”‚       â”‚     remote_ip: new value,
    â”‚   â”‚   â”‚       â”‚     location: new value,
    â”‚   â”‚   â”‚       â”‚     expiration_at: new timestamp,
    â”‚   â”‚   â”‚       â”‚     last_rotated_at: now
    â”‚   â”‚   â”‚       â”‚   }
    â”‚   â”‚   â”‚       â”‚
    â”‚   â”‚   â”‚       â””â”€> Log rotation:
    â”‚   â”‚   â”‚             { action: 'auto_rotate_expiration', ... }
    â”‚   â”‚   â”‚
    â”‚   â”‚   â””â”€> ELSE: Skip (not expired yet)
    â”‚   â”‚
    â”‚   â””â”€> Done
    â”‚
    â”œâ”€> OPTION 2: Timed auto-rotation (if enabled)
    â”‚   â”‚
    â”‚   â”œâ”€> Get interval from settings: auto_rotate_interval_minutes
    â”‚   â”‚
    â”‚   â”œâ”€> For each active proxy:
    â”‚   â”‚   â”‚
    â”‚   â”‚   â”œâ”€> Calculate time since last rotation:
    â”‚   â”‚   â”‚   minutes_elapsed = (now - last_rotated_at) / 60
    â”‚   â”‚   â”‚
    â”‚   â”‚   â”‚   IF minutes_elapsed >= interval_minutes:
    â”‚   â”‚   â”‚       â”‚
    â”‚   â”‚   â”‚       â”œâ”€> Call KiotProxy API (same as above)
    â”‚   â”‚   â”‚       â”‚
    â”‚   â”‚   â”‚       â”œâ”€> Update proxy handler (same as above)
    â”‚   â”‚   â”‚       â”‚
    â”‚   â”‚   â”‚       â”œâ”€> Update data.json (same as above)
    â”‚   â”‚   â”‚       â”‚
    â”‚   â”‚   â”‚       â””â”€> Log rotation:
    â”‚   â”‚   â”‚             { action: 'auto_rotate_interval', 
    â”‚   â”‚   â”‚               interval: X minutes, ... }
    â”‚   â”‚   â”‚
    â”‚   â”‚   â””â”€> ELSE: Skip (interval not reached)
    â”‚   â”‚
    â”‚   â””â”€> Done
    â”‚
    â””â”€> Sleep 30 seconds â†’ Repeat

Note: If both options are enabled, interval rotation takes priority
```

### Example Scenarios

**Scenario 1: Auto-rotate on expiration (Default)**
```
Proxy created at: 10:00 AM
Expiration at: 10:30 AM (30 minutes TTL)
Worker checks every 30 seconds

10:29 AM - Check: Not expired yet, skip
10:29:30 AM - Check: Expired in 30 seconds, ROTATE NOW
10:30 AM - New proxy active, new expiration at 11:00 AM
```

**Scenario 2: Timed auto-rotation (5 minutes)**
```
User sets interval: 5 minutes
Proxy last rotated at: 10:00 AM

10:04 AM - Check: Only 4 minutes, skip
10:05 AM - Check: 5 minutes passed, ROTATE NOW
10:05 AM - New proxy, last_rotated_at updated
10:10 AM - Check: 5 minutes passed, ROTATE AGAIN
```

**Scenario 3: Both enabled**
```
Expiration: 30 minutes
Interval: 5 minutes

Timeline:
10:00 - Proxy created
10:05 - Rotated (interval)
10:10 - Rotated (interval)
10:15 - Rotated (interval)
10:20 - Rotated (interval)
10:25 - Rotated (interval)
10:30 - Would rotate on expiration, but already rotated at 10:25

Note: Interval rotation resets expiration timer
```

---

## File System Layout

```
/app/
â”œâ”€â”€ data/
â”‚   â””â”€â”€ data.json                    # All persistent data
â”‚
â”œâ”€â”€ traefik/
â”‚   â””â”€â”€ dynamic/
â”‚       â””â”€â”€ proxies.yml              # Generated Traefik config
â”‚
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ main.py                      # FastAPI application
â”‚   â”œâ”€â”€ auth.py                      # Authentication logic
â”‚   â”œâ”€â”€ database.py                  # JSON file operations
â”‚   â”œâ”€â”€ kiotproxy.py                 # KiotProxy API client
â”‚   â”œâ”€â”€ proxy_handler.py             # HTTP proxy server
â”‚   â”œâ”€â”€ traefik_config.py            # Traefik config generator
â”‚   â”œâ”€â”€ worker.py                    # Background tasks
â”‚   â””â”€â”€ models.py                    # Pydantic models
â”‚
â””â”€â”€ logs/
    â””â”€â”€ app.log                      # Application logs
```

---

*Document Version: 2.0 (Simplified)*
*Last Updated: November 13, 2025*
*Architecture: Public Subdomains with Traefik Routing*
